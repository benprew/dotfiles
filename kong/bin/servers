#!/usr/bin/env ruby

servers = ["kongbus", "kongcab", "kongshred", "kongboat", "kongzep"]
`git fetch --all` #Make sure we're up-to-date
local_branch = `git rev-parse --abbrev-ref HEAD`

infos = servers.map do |server|
  url = "http://www.#{server}.com"
  STDERR.write(".")
  sha = `curl -s #{url}/revision.txt`.strip
  { hostname: server,
    branch: `curl -s #{url}/system/branch.html`.strip,
    author: `git --no-pager show -s --format='%an' #{sha}`.strip,
    revision: sha,
    deploy_time: `curl -s #{url}/deploy_time.txt`.split("\n") }
end
STDERR.write("\n")
infos.sort do |a,b|
  a[:deploy_time].last.to_f <=> b[:deploy_time].last.to_f
end.each do |server|
  puts "#{server[:branch].match(local_branch) ? '*' : ' '} #{server[:hostname]}:",
       "\tAuthor: #{server[:author]}",
       "\tDeploy: #{server[:deploy_time].first}",
       "\tBranch: #{server[:branch]}",
       "\tCommit: #{server[:revision]}"
end

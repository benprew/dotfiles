#!/usr/bin/env bash

set -e
set -x

branch=$1
server=$2

if [[ $branch == "" || $server == "" ]]; then
    echo Usage: git-qa BRANCH SERVER
    exit 1
fi

if [[ $branch == "HEAD" ]]; then
    branch=`git name-rev --name-only HEAD`
fi

export SKIP_MARGINALIA_LOGGING=1
git push origin $branch
git checkout qa_review
git fetch origin
git reset --hard origin/qa_review
git merge $branch
git push origin qa_review
marginalia dataappend 401 type=deploy branch=$branch server=$server &
cap ${server}_deploy
git checkout $branch
